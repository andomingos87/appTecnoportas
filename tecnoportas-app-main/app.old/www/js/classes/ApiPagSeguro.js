"use strict";var aps_is_sandbox=!0,thisUser=app.thisUser;function ApiPagSeguro(){function r(e){"undefined"==typeof PagSeguroDirectPayment?app.addScript(aps_is_sandbox?a:o,function(){c(e)}):c(e)}var i=this,m=thisUser,g="pagar?metodo=pagseguro",o="https://stc.pagseguro.uol.com.br/pagseguro/api/v2/checkout/pagseguro.directpayment.js",a="https://stc.sandbox.pagseguro.uol.com.br/pagseguro/api/v2/checkout/pagseguro.directpayment.js",n=null,f=null,b=null,p=null,u={SEMANAL:"WEEKLY",MENSAL:"MONTHLY",BIMESTRAL:"BIMONTHLY",TRIMESTRAL:"TRIMONTHLY",SEMESTRAL:"SEMIANNUALLY",ANUAL:"YEARLY"},l={SEGUNDA:"MONDAY",TERCA:"TUESDAY",QUARTA:"WEDNESDAY",QUINTA:"THURSDAY",SEXTA:"FRIDAY",SABADO:"SATURDAY",DOMINGO:"SUNDAY"},t=new VarGlobal("aps_sessao"),n=t.obterSessao(),m=m&&m[0],d=function(){PagSeguroDirectPayment.onSenderHashReady(function(e){"error"==e.status?console.log(e.message):f=e.senderHash})},c=function(e){t.obterSessao()||(PagSeguroDirectPayment.setSessionId(n),t.salvarSessao(n),d()),"function"==typeof e&&e(n)};i.init=function(o){n?r(o):new Api(g+"&acao=getsessao").send(function(e){e.error?app.Erro(e):(n=e.sessao.id,r(o))})},i.getApsUrl=function(){return"https://stc.pagseguro.uol.com.br"},i.getPaymentMethods=function(o,r){i.init(function(){o=N(o);var e={complete:r};o&&(e.amount=o),PagSeguroDirectPayment.getPaymentMethods(e)})},i.getBrand=function(e,o){e?6<=(e=String(e)).length?(e=e.substring(0,6),i.init(function(){PagSeguroDirectPayment.getBrand({cardBin:e,complete:o})})):o({error:"Bin Inválido!"}):o({error:"Bin Não Recebido!"})},i.getInstallments=function(a,n,e,t){(a=N(a))?i.init(function(){function r(e){var o={amount:a,complete:n};2<=N(t)&&(o.maxInstallmentNoInterest=N(t)),e&&(o.brand=e),PagSeguroDirectPayment.getInstallments(o)}N(e)?i.getBrand(e,function(e){var o;e.brand&&(o=e.brand.name),r(o)}):r(e)}):n({error:"Valor Inválido!"})},i.getCardToken=function(o,r,a,n,t,d){r?i.init(function(){var e={complete:function(e){e.error||(b=e.card.token),d(e)},cardNumber:String(o),brand:r};a&&(e.cvv=String(a)),n&&(e.expirationMonth=String(n)),t&&(e.expirationYear=String(t)),PagSeguroDirectPayment.createCardToken(e)}):d({error:"Dados Incompletos!"})},i.pagar=function(e,o,r,a,n,t,d,i){if(!f)return app.Erro({error:(b?"Hash do usuário":"Tokem do cartão")+" não recebido!"}),!1;var c={},s={endereco:{},enderecoFat:{}};if(n)c=n;else{if(!m)return app.Erro({error:"Dados do comprador não recebidos!"}),!1;var n=m.celWhats.replace(/[^0-9]/g,""),p=n.substring(0,2),n=n.substring(2),u="pf"==m.tipoCad?"CPF":"CNPJ",l=("pf"==m.tipoCad?m.cpf:m.cnpj).replace(/[^0-9]/g,""),c={nome:m.nome+" "+m.sobrenome,email:m.emailContato,ddd:p,tel:n,tipoDoc:u,doc:l}}if(c.senderHash=f,r)s.endereco=r.endereco,s.enderecoFat=r.enderecoFat,s.endereco||r.logradouro&&(s.endereco=r,s.enderecoFat=r);else{if(!m.logradouro)return app.Erro({error:"Endereço do comprador não recebidos!"}),!1;s.endereco={rua:m.logradouro,numero:m.numero,bairro:m.bairro,cidade:m.cidade,estado:m.estado,cep:m.cep},s.enderecoFat=s.endereco}p={metodoPag:e,referencia:app.nome+"-"+MD5((new Date).getTime()),requerEntrega:!!r,comprador:c,itens:o,endereco:s.endereco,enderecoFat:s.enderecoFat};if(d&&(p.tipoFrete=d.tipo,p.totalFrete=d.total),a&&"creditCard"==e&&b)p.cartaoCredito={token:b,parcelas:a.parcelas,valorParcelas:a.valorParcelas,nome:a.nome,tipoDoc:a.tipoDoc,doc:a.doc,dataNasc:a.dataNasc},2<=a.parcelasSemJuros&&(p.cartaoCredito.parcelasSemJuros=a.parcelasSemJuros);else if(a&&"eft"==e)p.banco={nome:a.nomeBanco};else if("eft"==e||"creditCard"==e)return app.Erro({error:"Os dados obrigatórios para o metodo não foram recebidos!"}),!1;i&&(p.urlRedireciona=i),new Api(g+"&acao=setpag",{dados:p}).send(function(e){t(e)})},i.getPlano=function(e,o,r,a,n,t,d){var i={},c={};if(a)i=a;else{if(!m)return app.Erro({error:"Dados do comprador não recebidos!"}),!1;var a=m.celWhats.replace(/[^0-9]/g,""),s=a.substring(0,2),a=a.substring(2),i={nome:m.nome+" "+m.sobrenome,email:m.emailContato,ddd:s,tel:a}}if(t)c=t;else{if(!m.logradouro)return app.Erro({error:"Endereço do comprador não recebidos!"}),!1;c={rua:m.logradouro,numero:m.numero,bairro:m.bairro,cidade:m.cidade,estado:m.estado,cep:m.cep}}s={tipo:e,nome:r.nome,detalhes:r.detalhes,valor:N(r.valor,2,"."),periodo:u[o.toUpperCase()],maxValorPeriodo:N(r.maxValorPeriodo,2,"."),dataInicial:r.dataInicial,dataFinal:r.dataFinal,valorTotalMaximo:N(r.valorTotalMaximo,2,"."),referencia:app.nome+"-"+MD5((new Date).getTime()),comprador:i,endereco:c};r.diaDoAno&&(s.diaDoAno=r.diaDoAno),r.diaDaSemana&&(s.diaDaSemana=l[r.diaDaSemana.toUpperCase()]),r.diaDoMes&&(s.diaDoMes=r.diaDoMes),r.taxaAdesao&&(s.taxaAdesao=N(r.taxaAdesao,2,".")),r.maxValor&&(s.maxValor=N(r.maxValor,2,".")),r.maxCobrancasPeriodo&&(s.maxCobrancasPeriodo=N(r.maxCobrancasPeriodo,2,".")),d&&(s.urlRedireciona=d),new Api(g+"&acao=getPlano",{dados:s}).send(function(e){e.error||(p=e.code,e.url=(aps_is_sandbox?"https://sandbox.pagseguro.uol.com.br/v2/pre-approvals/request.html?code=":"https://pagseguro.uol.com.br/v2/pre-approvals/request.html?code=")+p),n(e)})},i.setPlano=function(e,o,r,a,n){if(!(f&&b&&p))return app.Erro({error:(b?f?"Id do plano":"Hash do usuário":"Tokem do cartão")+" não recebido!"}),!1;var t={},d={endereco:{},enderecoFat:{}};if(o)t=o;else{if(!m)return app.Erro({error:"Dados do comprador não recebidos!"}),!1;var o=m.celWhats.replace(/[^0-9]/g,""),i=o.substring(0,2),o=o.substring(2),c="pf"==m.tipoCad?"CPF":"CNPJ",s=("pf"==m.tipoCad?m.cpf:m.cnpj).replace(/[^0-9]/g,""),t={nome:m.nome+" "+m.sobrenome,email:m.emailContato,ddd:i,tel:o,tipoDoc:c,doc:s}}if(t.senderHash=f,a)d.endereco=a.endereco,d.enderecoFat=a.enderecoFat,d.endereco||a.logradouro&&(d.endereco=a,d.enderecoFat=a);else{if(!m.logradouro)return app.Erro({error:"Endereço do comprador não recebidos!"}),!1;d.endereco={rua:m.logradouro,numero:m.numero,bairro:m.bairro,cidade:m.cidade,estado:m.estado,cep:m.cep},d.enderecoFat=d.endereco}i={planoId:p,referencia:app.nome+"-"+MD5((new Date).getTime()),comprador:t,endereco:d.endereco,enderecoFat:d.enderecoFat};e&&b&&(i.cartaoCredito={token:b,nome:e.nome,tipoDoc:e.tipoDoc,doc:e.doc,dataNasc:e.dataNasc}),n&&(i.urlRedireciona=n),new Api(g+"&acao=setplano",{dados:i}).send(function(e){r(e)})}}